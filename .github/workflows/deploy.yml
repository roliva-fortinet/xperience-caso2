  Lacework-Scanner:
    name: 🔍 Lacework IaC Scan
    needs: Initialize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create environment variables file
        run: |
          env | grep "GITHUB_\\|LW_\\|CI_" > env.list
          echo "LW_ACCOUNT=${{ secrets.LW_ACCOUNT }}" >> env.list
          echo "LW_API_KEY=${{ secrets.LW_API_KEY }}" >> env.list
          echo "LW_API_SECRET=${{ secrets.LW_API_SECRET }}" >> env.list

      - name: Run Lacework IaC Scan and fail on Critical findings
        id: scan
        run: |
          set -o pipefail
          OUTPUT=$(docker run --rm \
            --env-file env.list \
            -v "$PWD:/workdir" \
            -w /workdir \
            lacework/codesec-iac \
            lacework iac scan --directory /workdir 2>&1)

          echo "$OUTPUT"

          # Busca "Severity: Critical" en la salida
          echo "$OUTPUT" | grep -i "severity: critical" && {
            echo "🚨 Found Critical IaC findings. Failing the job."
            exit 1
          }

          echo "✅ No critical findings detected."

      - name: Upload Scan Reports (if any)
        uses: actions/upload-artifact@v4
        with:
          name: Lacework IaC Reports
          path: /tmp/iac_reports/*

      - name: Publish IaC Scan Summary
        run: |
          echo "Summary not available because JSON reports are not generated with current docker CLI."
